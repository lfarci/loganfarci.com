# 07 — Config and Infrastructure

This document covers all configuration file changes: Vite config, TypeScript, ESLint, environment variables, CI/CD workflow, and Azure Static Web Apps.

## Vite Config

### Create `src/vite.config.ts`

```typescript
import { defineConfig } from "vite";
import react from "@vitejs/plugin-react";
import path from "path";
import markdownPlugin from "./plugins/vite-plugin-markdown";

export default defineConfig({
    plugins: [react(), markdownPlugin()],
    resolve: {
        alias: {
            "@/": path.resolve(__dirname, "src") + "/",
            "@content/": path.resolve(__dirname, "../content") + "/",
        },
    },
    build: {
        outDir: "dist",
    },
    server: {
        fs: {
            allow: [".."], // Allow reading content/ outside project root
        },
    },
});
```

### Delete `src/next.config.ts`

The Next.js configuration has no Vite equivalent — all relevant settings are covered in `vite.config.ts`:

| `next.config.ts` option | Vite equivalent |
|---|---|
| `output: "export"` | Default (Vite always outputs static files); prerender script adds SSG |
| `trailingSlash: true` | Handled by prerender script writing `route/index.html` |
| `images: { unoptimized: true }` | N/A (using native `<img>`) |

## TypeScript Config

### Update `src/tsconfig.json`

```diff
 {
     "compilerOptions": {
-        "target": "ES2017",
+        "target": "ES2020",
         "lib": ["dom", "dom.iterable", "esnext"],
         "allowJs": true,
         "skipLibCheck": true,
         "strict": true,
         "noEmit": true,
         "esModuleInterop": true,
         "module": "esnext",
         "moduleResolution": "bundler",
-        "resolveJsonModule": true,
+        "resolveJsonModule": true,
         "isolatedModules": true,
         "jsx": "react-jsx",
-        "incremental": true,
-        "plugins": [
-            {
-                "name": "next"
-            }
-        ],
+        "types": ["vite/client"],
         "paths": {
-            "@/*": ["./src/*"]
+            "@/*": ["./src/*"],
+            "@content/*": ["../content/*"]
         }
     },
-    "include": ["next-env.d.ts", "**/*.ts", "**/*.tsx", ".next/types/**/*.ts"],
+    "include": ["**/*.ts", "**/*.tsx", "plugins/**/*.ts"],
     "exclude": ["node_modules"]
 }
```

**Key changes**:
- Remove `"plugins": [{ "name": "next" }]` — Next.js TypeScript plugin
- Remove `next-env.d.ts` and `.next/types/**` from `include`
- Add `"types": ["vite/client"]` — provides types for `import.meta.env`, `import.meta.glob`, etc.
- Add `@content/*` path alias
- Add `plugins/**/*.ts` to `include` (for the custom Vite plugin)
- Optionally bump `target` to `ES2020` (Vite's default browser target)

### Delete `next-env.d.ts`

This file is auto-generated by Next.js and references Next.js type declarations. Delete it.

## ESLint Config

### Update `src/eslint.config.mjs`

```diff
 import { dirname } from "path";
 import { fileURLToPath } from "url";
 import { FlatCompat } from "@eslint/flatcompat";
 import tseslint from "typescript-eslint";
 import eslintConfigPrettier from "eslint-config-prettier";
-import nextPlugin from "@next/eslint-plugin-next";
 
 const __filename = fileURLToPath(import.meta.url);
 const __dirname = dirname(__filename);
 
 const compat = new FlatCompat({
     baseDirectory: __dirname,
 });
 
 const eslintConfig = [
-    ...compat.extends("next/core-web-vitals", "next/typescript"),
     ...tseslint.configs.recommendedTypeChecked,
     eslintConfigPrettier,
     {
         languageOptions: {
             parserOptions: {
                 projectService: true,
                 tsconfigRootDir: __dirname,
             },
         },
     },
-    {
-        plugins: {
-            "@next/next": nextPlugin,
-        },
-        rules: {
-            ...nextPlugin.configs["core-web-vitals"].rules,
-        },
-    },
     {
-        ignores: [".next", "out", "node_modules"],
+        ignores: ["dist", "node_modules"],
     },
 ];
 
 export default eslintConfig;
```

**Key changes**:
- Remove `@next/eslint-plugin-next` import and usage
- Remove `next/core-web-vitals` and `next/typescript` extends
- Replace `.next` and `out` ignore patterns with `dist`

## Environment Variables

### Rename convention

| Before (Next.js) | After (Vite) |
|---|---|
| `NEXT_PUBLIC_GITHUB_REPOSITORY_URL` | `VITE_GITHUB_REPOSITORY_URL` |
| `NEXT_PUBLIC_COMMIT_HASH` | `VITE_COMMIT_HASH` |
| `ARTICLES_DIRECTORY` | **Removed** (content resolved via Vite alias) |
| `DATA_DIRECTORY` | **Removed** (content resolved via Vite alias) |

### Access pattern

```typescript
// Before
process.env.NEXT_PUBLIC_GITHUB_REPOSITORY_URL
process.env.NEXT_PUBLIC_COMMIT_HASH
process.env.NODE_ENV

// After
import.meta.env.VITE_GITHUB_REPOSITORY_URL
import.meta.env.VITE_COMMIT_HASH
import.meta.env.MODE  // "development" | "production"
import.meta.env.DEV   // true in dev
import.meta.env.PROD  // true in production
```

### Add type declarations

Create or update `src/src/vite-env.d.ts`:

```typescript
/// <reference types="vite/client" />

interface ImportMetaEnv {
    readonly VITE_GITHUB_REPOSITORY_URL?: string;
    readonly VITE_COMMIT_HASH?: string;
}

interface ImportMeta {
    readonly env: ImportMetaEnv;
}
```

## Package.json

### Update `src/package.json`

```diff
 {
     "scripts": {
-        "dev": "next dev --turbopack",
-        "build": "next build",
-        "start": "next start",
+        "dev": "vite",
+        "build": "vite build && vite build --ssr src/entry-server.tsx --outDir dist/server && node scripts/prerender.mjs",
+        "preview": "vite preview",
         "lint": "eslint . --ext .ts,.tsx"
     },
     "dependencies": {
-        "next": "^16.0.3",
         "react": "^19.1.1",
         "react-dom": "^19.1.1",
+        "react-router": "^7.0.0",
+        "react-helmet-async": "^2.0.0",
         "@heroui/react": "^2.8.2",
         "framer-motion": "^12.23.11",
-        "gray-matter": "^4.0.3",
         "mermaid": "^11.9.0",
         "react-markdown": "^10.1.0",
         "remark-gfm": "^4.0.1"
     },
     "devDependencies": {
+        "vite": "^6.0.0",
+        "@vitejs/plugin-react": "^4.0.0",
+        "gray-matter": "^4.0.3",
+        "@fontsource-variable/manrope": "*",
+        "@fontsource/noto-sans": "*",
+        "@fontsource/reddit-mono": "*",
         "@tailwindcss/postcss": "^4.1.12",
         "tailwindcss": "^4.1.12",
         "typescript": "^5.8.3",
-        "eslint-config-next": "16.0.3",
         "@eslint/eslintrc": "^3",
         "eslint": "^9",
         "eslint-config-prettier": "^10.1.5",
         "typescript-eslint": "^8.33.0",
         "@azure/static-web-apps-cli": "^2.0.6"
     }
 }
```

**Key changes**:
- `gray-matter` moved to `devDependencies` (only used by the Vite plugin at build time)
- `next` and `eslint-config-next` removed
- `vite`, `@vitejs/plugin-react`, `react-router`, `react-helmet-async`, Fontsource packages added

## Azure Static Web Apps Config

### Update `src/public/staticwebapp.config.json`

```diff
 {
     "navigationFallback": {
         "rewrite": "/404.html",
-        "exclude": ["/images/*.{png,jpg,gif,svg,ico,webp}", "/_next/*", "/favicon.ico"]
+        "exclude": ["/images/*.{png,jpg,gif,svg,ico,webp,avif}", "/assets/*", "/favicon.ico"]
     },
     "responseOverrides": {
         "404": {
             "rewrite": "/404.html",
             "statusCode": 404
         }
     }
 }
```

**Changes**:
- `/_next/*` → `/assets/*` (Vite's output directory for hashed static assets)
- Added `avif` to image exclusion pattern (the site uses `.avif` images)

## CI/CD Workflow

### Rename and update `.github/workflows/next-app.yml` → `.github/workflows/deploy-app.yml`

```diff
-name: "Deploy Next Application"
+name: "Deploy Application"
 
 on:
   push:
     branches:
       - main
     paths:
       - "src/**"
       - "content/**"
   pull_request:
     types: [opened, synchronize, reopened]
     branches:
       - main
     paths:
       - "src/**"
       - "content/**"
   workflow_dispatch:
 
 permissions:
   id-token: write
   contents: read
 
 env:
   src_directory: ${{ github.workspace }}/src
-  out_directory: ${{ github.workspace }}/src/out
-  articles_directory: ${{ github.workspace }}/content/articles
-  data_directory: ${{ github.workspace }}/content/data
+  out_directory: ${{ github.workspace }}/src/dist
 
 jobs:
   deploy:
-    name: "Deploy Next Application"
+    name: "Deploy Application"
     runs-on: ubuntu-latest
     environment:
       name: Production
     defaults:
       run:
         working-directory: ${{ github.workspace }}/src
     steps:
       - name: Checkout code
         uses: actions/checkout@v4
 
       - name: Get npm cache directory
         id: npm-cache-dir
         run: echo "dir=$(npm config get cache)" >> $GITHUB_OUTPUT
 
-      - name: Cache Next.js build
+      - name: Cache build
         uses: actions/cache@v4
         with:
           path: |
             ${{ steps.npm-cache-dir.outputs.dir }}
-            ${{ env.src_directory }}/.next/cache
-          key: ${{ runner.os }}-nextjs-${{ hashFiles('**/package-lock.json') }}-${{ hashFiles('**/*.ts', '**/*.tsx') }}
-          restore-keys: ${{ runner.os }}-nextjs-${{ hashFiles('**/package-lock.json') }}-
+            ${{ env.src_directory }}/node_modules/.vite
+          key: ${{ runner.os }}-vite-${{ hashFiles('**/package-lock.json') }}-${{ hashFiles('**/*.ts', '**/*.tsx') }}
+          restore-keys: ${{ runner.os }}-vite-${{ hashFiles('**/package-lock.json') }}-
 
       - name: Install dependencies
         run: npm clean-install
 
       - name: Build application
         run: npm run build
         env:
-          ARTICLES_DIRECTORY: "${{ env.articles_directory }}"
-          DATA_DIRECTORY: "${{ env.data_directory }}"
-          NEXT_PUBLIC_GITHUB_REPOSITORY_URL: "${{ github.server_url }}/${{ github.repository }}"
-          NEXT_PUBLIC_COMMIT_HASH: "${{ github.sha }}"
+          VITE_GITHUB_REPOSITORY_URL: "${{ github.server_url }}/${{ github.repository }}"
+          VITE_COMMIT_HASH: "${{ github.sha }}"
 
       - name: Azure CLI Login
         uses: azure/login@v2
         # ... (unchanged)
 
       - name: Deploy to Azure Static Web Apps
         run: |
           npx swa deploy ${{ env.out_directory }} --deployment-token ${{ steps.get-secrets.outputs.deployment_token }} --env ${{ steps.environment.outputs.name }}
```

**Key changes**:
- Remove `articles_directory` and `data_directory` env vars (Vite resolves content via aliases)
- Rename `NEXT_PUBLIC_*` → `VITE_*` env vars
- Change output directory `out` → `dist`
- Change cache directory `.next/cache` → `node_modules/.vite`
- Update cache key prefix `nextjs` → `vite`

## .gitignore

### Update `src/.gitignore`

```diff
-# Next.js
-.next/
-out/
+# Vite
+dist/

 # dependencies
 node_modules/
```

## Tailwind Config

### Verify `src/tailwind.config.ts`

The `content` array should include the new pages directory:

```typescript
content: [
    "./index.html",
    "./src/**/*.{js,ts,jsx,tsx}",
    // HeroUI theme
    "./node_modules/@heroui/theme/dist/**/*.{js,ts,jsx,tsx}",
],
```

## Migration Checklist

- [ ] Create `src/vite.config.ts`
- [ ] Delete `src/next.config.ts`
- [ ] Update `src/tsconfig.json` (remove Next.js plugin, add Vite types)
- [ ] Delete `next-env.d.ts`
- [ ] Update `src/eslint.config.mjs` (remove Next.js plugin)
- [ ] Create `src/src/vite-env.d.ts` (env type declarations)
- [ ] Update `src/package.json` (dependencies, scripts)
- [ ] Update `src/public/staticwebapp.config.json` (asset path)
- [ ] Rename and update CI/CD workflow file
- [ ] Update `src/.gitignore`
- [ ] Verify Tailwind `content` paths
- [ ] Run `npm install` and verify no errors
- [ ] Run `npm run build` and verify `dist/` output
- [ ] Run `npm run dev` and verify dev server starts
